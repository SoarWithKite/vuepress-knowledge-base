---
title: 复制
date: 2024-08-05 15:18:30
permalink: /pages/200e04/
---
# 复制

官网：https://redis.io/docs/management/replication/

## 介绍

**是什么**

<img src="https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325094314772.png" alt="image-20230325094314772" style="zoom:67%;" />

> 一句话
>
> 就是主从复制，master以写为主，Slave以读为主
>
> 当master数据变化的时候，自动将新的数据异步同步到其它slave数据库

**能干嘛**

- 读写分离
- 容灾恢复
- 数据备份
- 水平扩容支撑高并发

**如何使用**

- 配从(库)不配主(库)

- 权限细节，重要

  master如果配置了requirepass参数，需要密码登陆，否则的话master会拒绝slave的访问请求

  <img src="https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325094749676.png" alt="image-20230325094749676" style="zoom:67%;" />

- 基本操作命令

  - info replication可以查看复制节点的主从关系和配置信息

  - replicaof 主库IP 主库端口一般写入进redis.conf配置文件内

  - slaveof 主库IP 主库端口每次与master断开之后，都需要重新连接，除非你配置进redis.conf文件

    在运行期间修改slave节点的信息，如果该数据库已经是某个主数据库的从数据库，那么会停止和原主数据库的同步关系转而和新的主数据库同步，重新拜码头

  - slaveof no one使当前数据库停止与其他数据库的同步，转成主数据库，自立为王

## 案例演示

**架构说明**

一个Master两个Slave，3台虚机，三边网络相互ping通且注意防火墙配置，每台都安装redis，

![image-20230325101715614](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325101715614.png)

修改配置文件

1. 开启daemonize yes

   <img src="https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325104111118.png" alt="image-20230325104111118"  />

2. 注释掉bind 127.0.0.1

   ![image-20230325104217340](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325104217340.png)

3. protected-mode no

   ![image-20230325104300980](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325104300980.png)

4. 指定端口

   ![image-20230325104523481](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325104523481.png)

5. 指定当前工作目录，dir

   ![image-20230325104627382](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325104627382.png)

6. pid文件名字,pidfile

   ![image-20230325104708942](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325104708942.png)

7. log文件名字,logfile

   ![image-20230325104809123](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325104809123.png)

8. requirepass

   ![image-20230325104937457](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325104937457.png)

9. dump.rdb名字

   ![image-20230325105043191](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325105043191.png)

10. aof文件,appendfilename

    ![image-20230325105147304](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325105147304.png)

    本步骤可选，非必须

    ![image-20230325105308115](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325105308115.png)

11. 从机访问主机的通行密码masterauth，从机需要配置，主机不用

    ![image-20230325111124546](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325111124546.png)

### 一仆二从

#### 配置文件固定写死

先master后两台slave依次启动

![image-20230325111838506](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325111838506.png)

主从关系查看

- 日志查看

  6379日志

  <img src="https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325112437799.png" alt="image-20230325112437799" style="zoom: 80%;" />

  6380日志

  ![image-20230325112937622](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325112937622.png)

  6381日志

  ![image-20230325112931827](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325112931827.png)

- info replication命令查看

  <img src="https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325113406421.png" alt="image-20230325113406421"  />

#### 主从问题演示

- 从机可以执行写命令吗？

  不可以

  ![image-20230325115418705](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325115418705.png)

- 从机切入点问题

  slave是从头开始复制还是从切入点开始复制?

   master启动，写到k3

   slave1跟着master同时启动，跟着写到k3

   slave2写到k3后才启动，那之前的是否也可以复制？

  可以，首次全量复制（一锅端），后续跟随，master写，slave跟

- 主机shutdown后，从机会上位吗？

  从机不动，原地待命，从机数据可以正常使用；等待主机重启动归来

  ![image-20230325115623581](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325115623581.png)

- 主机shutdown后，重启后主从关系还在吗？从机还能否顺利复制？

  还在，可以

- 某台从机down后，master继续，从机重启后它能跟上大部队吗？

  可以

#### 命令操作手动指定

从机停机去掉配置文件中的配置项，3台目前都是主机状态，各不从属

![image-20230325120739567](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325120739567.png)

三台master主机

![image-20230325120837279](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325120837279.png)

预设的从机上执行命令

slaveof 主库IP 主库端口

效果

![image-20230325120954787](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325120954787.png)

用命令使用的话，2台从机重启后，关系还在吗？

<img src="https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325121028669.png" alt="image-20230325121028669" style="zoom:67%;" />

依然存在。配置是持久稳定生效的，命令只有当次生效

### 薪火相传

上一个slave可以是下一个slave的master，slave同样可以接收其他slaves的连接和同步请求，那么该slave作为了链条中下一个的master,可以有效减轻主master的写压力

中途变更转向:会清除之前的数据，重新建立拷贝最新的

### 反客为主

SLAVEOF no one

使当前数据库停止与其他数据库的同步，转成主数据库

## 复制原理和工作流程

- slave启动，同步初请

  slave启动成功连接到master后会发送一个sync命令

  slave首次全新连接master,一次完全同步（全量复制)将被自动执行，slave自身原有数据会被master数据覆盖清除

- 首次连接，全量复制

  master节点收到sync命令后会开始在后台保存快照(即RDB持久化，主从复制时会触发RDB)，同时收集所有接收到的用于修改数据集命令缓存起来，master节点执行RDB持久化完后，master将rdb快照文件和所有缓存的命令发送到所有slave,以完成一次完全同步

  而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中，从而完成复制初始化

- 心跳持续，保持通信

  repl-ping-replica-period 10 master发出PING包的周期，默认是10秒

  ![image-20230325124122474](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325124122474.png)

- 进入平稳，增量复制

  Master继续将新的所有收集到的修改命令自动依次传给slave,完成同步

- 从机下线，重连续传

  master会检查backlog里面的offset，master和slave都会保存一个复制的offset还有一个masterId，offset是保存在backlog中的。**Master只会把已经复制的offset后面的数据复制给Slave**，类似断点续传

**缺点**

- 复制延时，信号衰减

  由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。

  ![image-20230325124347677](https://gitee.com/kiteflyer/picture/raw/master/Redis/image-20230325124347677.png)

- master挂了如何办？

  默认情况下，不会在slave节点中自动重选一个master，每次都需要人工重启。





